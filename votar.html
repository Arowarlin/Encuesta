<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Encuesta - Emite tu Voto</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <nav class="bg-indigo-600 text-white shadow-lg">
    <div class="container mx-auto px-6 py-4">
      <h1 class="text-2xl font-bold">üó≥Ô∏è Encuesta de Votaci√≥n</h1>
    </div>
  </nav>

  <div class="container mx-auto px-6 py-8">
    <div id="loading" class="text-center py-20">
      <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-600 mx-auto mb-4"></div>
      <p class="text-gray-600">Verificando acceso...</p>
    </div>

    <div id="error" class="hidden max-w-2xl mx-auto">
      <div class="bg-red-50 border border-red-200 rounded-lg p-8 text-center">
        <svg class="w-16 h-16 text-red-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h2 class="text-2xl font-bold text-red-800 mb-4">Acceso Denegado</h2>
        <p id="errorMensaje" class="text-red-700 mb-6"></p>
        <a href="index.html" class="inline-block bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700">
          Volver al Inicio
        </a>
      </div>
    </div>

    <div id="formularioVoto" class="hidden max-w-4xl mx-auto">
      <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
        <div class="text-center mb-8">
          <h2 class="text-3xl font-bold text-gray-800 mb-2">Bienvenido(a)</h2>
          <p id="nombreParticipante" class="text-xl text-indigo-600 font-semibold"></p>
          <p class="text-gray-600 mt-2">Por favor, emite tu voto para cada cargo</p>
        </div>

        <form id="formVotar">
          <div id="cargosContainer" class="space-y-8"></div>

          <div class="mt-8 pt-6 border-t border-gray-200">
            <button type="submit" class="w-full bg-indigo-600 text-white py-4 rounded-lg hover:bg-indigo-700 font-semibold text-lg transition">
              ‚úÖ Enviar Mi Voto
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="exitoso" class="hidden max-w-2xl mx-auto">
      <div class="bg-green-50 border border-green-200 rounded-lg p-8 text-center">
        <svg class="w-16 h-16 text-green-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h2 class="text-2xl font-bold text-green-800 mb-4">¬°Voto Registrado Exitosamente!</h2>
        <p class="text-green-700 mb-6">Gracias por tu participaci√≥n</p>
        <a href="resultados.html" class="inline-block bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
          Ver Resultados
        </a>
      </div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script type="module">
    import { initFirebase } from './firebase-service.js';

    const db = initFirebase(firebaseConfig);
    let datosVotacion = null;

    async function cargarEncuesta() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      const correo = urlParams.get('correo');

      if (!token || !correo) {
        mostrarError('Enlace inv√°lido. Utiliza el enlace enviado a tu correo.');
        return;
      }

      try {
        const participante = await db.obtenerParticipantePorToken(token, correo);
        
        if (!participante) {
          mostrarError('No se encontr√≥ el participante o el enlace es inv√°lido.');
          return;
        }

        if (participante.haVotado) {
          mostrarError('Ya has votado anteriormente. No puedes votar dos veces.');
          return;
        }

        // Cargar cargos y aspirantes
        const [cargos, aspirantes] = await Promise.all([
          db.obtenerCargos(),
          db.obtenerAspirantes()
        ]);

        // Validar que existan datos
        if (!cargos || cargos.length === 0) {
          mostrarError('No hay cargos disponibles para votar.');
          return;
        }

        if (!aspirantes || aspirantes.length === 0) {
          mostrarError('No hay aspirantes registrados.');
          return;
        }

        // Organizar aspirantes por cargo (CORREGIDO: sin espacio en el nombre)
        const cargosConAspirantes = cargos.map(cargo => ({
          ...cargo,
          aspirantes: aspirantes.filter(a => a.cargoId === cargo.id)
        }));

        datosVotacion = {
          participante,
          cargos: cargosConAspirantes
        };

        mostrarFormulario();
      } catch (error) {
        console.error('Error detallado:', error);
        mostrarError(`Error al cargar la encuesta: ${error.message || 'Error desconocido'}`);
      }
    }

    function mostrarError(mensaje) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('errorMensaje').textContent = mensaje;
    }

    function mostrarFormulario() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('formularioVoto').classList.remove('hidden');
      
      const { participante, cargos } = datosVotacion;
      document.getElementById('nombreParticipante').textContent = 
        `${participante.nombre} ${participante.apellido}`;

      const container = document.getElementById('cargosContainer');
      container.innerHTML = cargos.map(cargo => `
        <div class="border border-gray-200 rounded-lg p-6 bg-gray-50">
          <h3 class="text-xl font-bold text-gray-800 mb-2">${cargo.nombre}</h3>
          ${cargo.descripcion ? `<p class="text-gray-600 mb-4">${cargo.descripcion}</p>` : ''}
          
          <div class="space-y-3">
            ${cargo.aspirantes.length > 0 ? cargo.aspirantes.map(aspirante => `
              <label class="flex items-center p-4 bg-white border border-gray-300 rounded-lg cursor-pointer hover:bg-indigo-50 hover:border-indigo-500 transition">
                <input type="radio" name="cargo_${cargo.id}" value="${aspirante.id}" data-tipo="aspirante" class="w-5 h-5 text-indigo-600" required>
                <div class="ml-4">
                  <div class="font-semibold text-gray-800">${aspirante.nombre}</div>
                  ${aspirante.descripcion ? `<div class="text-sm text-gray-600">${aspirante.descripcion}</div>` : ''}
                </div>
              </label>
            `).join('') : '<p class="text-gray-500 italic">No hay aspirantes para este cargo</p>'}
            
            <label class="flex items-center p-4 bg-white border border-gray-300 rounded-lg cursor-pointer hover:bg-yellow-50 hover:border-yellow-500 transition">
              <input type="radio" name="cargo_${cargo.id}" value="no_se" data-tipo="no_se" class="w-5 h-5 text-yellow-600" required>
              <div class="ml-4 font-semibold text-gray-700">ü§î No s√© / Indeciso</div>
            </label>
            
            <label class="flex items-center p-4 bg-white border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-100 hover:border-gray-500 transition">
              <input type="radio" name="cargo_${cargo.id}" value="ninguno" data-tipo="ninguno" class="w-5 h-5 text-gray-600" required>
              <div class="ml-4 font-semibold text-gray-700">‚ùå Ninguno / Voto en blanco</div>
            </label>
          </div>
        </div>
      `).join('');
    }

    document.getElementById('formVotar').addEventListener('submit', async (e) => {
      e.preventDefault();

      const votos = [];
      const { participante, cargos } = datosVotacion;

      for (const cargo of cargos) {
        const seleccionado = document.querySelector(`input[name="cargo_${cargo.id}"]:checked`);
        
        if (!seleccionado) {
          alert(`Por favor, selecciona una opci√≥n para: ${cargo.nombre}`);
          return;
        }

        const tipo = seleccionado.dataset.tipo;
        votos.push({
          cargoId: cargo.id,
          aspiranteId: tipo === 'aspirante' ? seleccionado.value : null,
          tipoVoto: tipo
        });
      }

      const btn = e.target.querySelector('button[type="submit"]');
      const textoOriginal = btn.textContent;
      btn.disabled = true;
      btn.textContent = '‚è≥ Enviando...';

      try {
        await db.registrarVoto(participante.id, votos);
        
        document.getElementById('formularioVoto').classList.add('hidden');
        document.getElementById('exitoso').classList.remove('hidden');
      } catch (error) {
        console.error('Error al registrar voto:', error);
        alert('‚ùå Error al registrar el voto: ' + (error.message || 'Error desconocido'));
        btn.disabled = false;
        btn.textContent = textoOriginal;
      }
    });

    // Iniciar carga de la encuesta
    cargarEncuesta();
  </script>
</body>
</html>